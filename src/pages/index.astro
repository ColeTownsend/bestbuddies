---
import Layout from "../layouts/Layout.astro";
import Page from "../components/react/page";
import { db, Supporters, Campaigns, eq, desc } from "astro:db";

// Fetch campaign data
const campaign = await db
  .select()
  .from(Campaigns)
  .where(eq(Campaigns.id, 1))
  .get();

// Fetch supporters ordered by creation date (most recent first)
const supporters = await db
  .select({
    name: Supporters.name,
    donation_amount: Supporters.donation_amount,
    created_at: Supporters.created_at,
  })
  .from(Supporters)
  .orderBy(desc(Supporters.created_at));

// Calculate current amount from sum of donations
const totalAmount = supporters.reduce(
  (sum, supporter) => sum + supporter.donation_amount,
  0
);

// Prepare data for the React component
const campaignData = {
  currentAmount: totalAmount,
  goalAmount: campaign?.goal_amount || 1800,
  supporters: supporters.map((s) => s.name),
  supportersCount: supporters.length,
};
---

<Layout>
  <Page client:only="react" campaignData={campaignData} />
</Layout>
