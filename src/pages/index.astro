---
import Layout from "../layouts/Layout.astro";
import Page from "../components/react/page";
import { CampaignQueries, SupporterQueries, initializeTables } from "../lib/db";

// Initialize tables on first run
await initializeTables();

// Fetch campaign data
console.log('🔍 Fetching campaign data...');
let campaign;
try {
  campaign = await CampaignQueries.getCampaign(1);
  console.log('✅ Campaign fetched:', campaign);
} catch (error) {
  console.error('❌ Campaign fetch error:', error);
  throw error;
}

// Fetch supporters ordered by creation date (most recent first)
console.log('🔍 Fetching supporters...');
let supporters;
try {
  supporters = await SupporterQueries.getAllSupporters();
  console.log('✅ Supporters fetched:', supporters.length, 'records');
} catch (error) {
  console.error('❌ Supporters fetch error:', error);
  throw error;
}

// Calculate current amount from sum of donations
const totalAmount = supporters.reduce(
  (sum, supporter) => sum + supporter.donation_amount,
  0
);

// Prepare data for the React component
const campaignData = {
  currentAmount: totalAmount,
  goalAmount: campaign?.goal_amount || 1800,
  supporters: supporters.map((s) => s.name),
  supportersCount: supporters.length,
};
---

<Layout>
  <Page client:only="react" campaignData={campaignData} />
</Layout>
